<!DOCTYPE html>
<html lang="en" class="dark:bg-gray-900 dark:text-white">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>PantryPal Pro</title>
  <link rel="manifest" href="manifest.json"/>
  <link rel="icon" href="icon-192.png"/>
  <meta name="theme-color" content="#6366f1"/>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/quagga/0.12.1/quagga.min.js"></script>
  <script src="https://unpkg.com/@zxing/library@0.20.0/dist/index.min.js"></script>
  <script src="https://unpkg.com/lucide@latest/dist/umd/lucide.min.js"></script>
  <style>
    :root { --glass: rgba(255,255,255,0.15); --glass-border: rgba(255,255,255,0.2); --shadow: 0 8px 32px rgba(0,0,0,0.12); }
    .dark { --glass: rgba(17,24,39,0.4); --glass-border: rgba(255,255,255,0.1); --shadow: 0 8px 32px rgba(0,0,0,0.4); }
    .glass { background: var(--glass); backdrop-filter: blur(16px); -webkit-backdrop-filter: blur(16px); border: 1px solid var(--glass-border); box-shadow: var(--shadow); }
    .gradient-bg { background: linear-gradient(135deg, #6366f1 0%, #8b5cf6 50%, #ec4899 100%); }
    .pro-badge { @apply bg-gradient-to-r from-yellow-400 to-orange-500 text-black px-3 py-1 rounded-full text-xs font-bold; }
    .low-stock { @apply bg-red-50 dark:bg-red-900 border-l-4 border-red-500 p-3 rounded-lg shadow-sm; }
    .spinner { width: 24px; height: 24px; border: 3px solid #e5e7eb; border-top: 3px solid #3b82f6; border-radius: 50%; animation: spin 1s linear infinite; }
    @keyframes spin { to { transform: rotate(360deg); } }
    @keyframes pulse { 0%,100% { transform: scale(1); } 50% { transform: scale(1.05); } }
    .pulse { animation: pulse 2s infinite; }
    #scanner-overlay::after { content: ''; position: absolute; top: 50%; left: 50%; width: 80%; height: 60px; border: 3px solid rgba(59,130,246,0.8); border-radius: 8px; transform: translate(-50%,-50%); box-shadow: 0 0 0 9999px rgba(0,0,0,0.5); pointer-events: none; }
  </style>
</head>
<body class="bg-gradient-to-br from-indigo-50 via-purple-50 to-pink-50 dark:from-gray-900 dark:via-purple-900 dark:to-pink-900 min-h-screen">
  <header class="gradient-bg text-white py-6 sticky top-0 z-50 shadow-2xl">
    <div class="max-w-4xl mx-auto px-6 flex justify-between items-center">
      <div class="flex items-center gap-4">
        <i data-lucide="home" class="w-10 h-10"></i>
        <div>
          <h1 class="text-3xl font-black">PantryPal <span class="pro-badge">PRO</span></h1>
          <p class="text-sm opacity-90">AI Scan • Voice • Family Sync</p>
        </div>
      </div>
      <button id="darkModeBtn" class="p-3 rounded-full bg-white/20 hover:bg-white/30 transition">
        <i data-lucide="moon" class="w-6 h-6"></i>
      </button>
    </div>
  </header>

  <section id="auth-section" class="max-w-md mx-auto mt-24 px-6">
    <div class="glass rounded-3xl p-10 text-center">
      <h2 class="text-3xl font-bold mb-8">Welcome to PantryPal Pro</h2>
      <div id="firebaseui-auth-container"></div>
    </div>
  </section>

  <main id="app" class="hidden max-w-4xl mx-auto px-6 py-10 space-y-10">
    <div class="glass rounded-2xl p-6">
      <div class="flex justify-between items-center mb-4">
        <div class="flex items-center gap-4">
          <i data-lucide="user" class="w-8 h-8"></i>
          <span class="font-bold text-lg" id="userEmail"></span>
          <span id="proStatus" class="pro-badge">FREE</span>
        </div>
        <button id="signOutBtn" class="bg-red-600 hover:bg-red-700 px-6 py-3 rounded-xl font-bold transition">Sign Out</button>
      </div>
      <div id="scanCounter" class="text-center font-medium">Loading...</div>
    </div>

    <button id="startScanner" class="w-full glass rounded-3xl py-8 flex items-center justify-center gap-5 text-2xl font-bold hover:scale-105 transition pulse">
      <i data-lucide="scan" class="w-12 h-12"></i>
      Start Scanner
    </button>

    <div class="glass rounded-3xl p-8 text-center">
      <button id="voiceBtn" class="bg-gradient-to-r from-purple-600 to-pink-600 hover:from-purple-700 hover:to-pink-700 text-white px-12 py-8 rounded-3xl font-black text-2xl shadow-2xl flex items-center justify-center gap-4">
        <i data-lucide="mic" class="w-12 h-12"></i>
        Hold to Speak
      </button>
      <div id="voiceResult" class="mt-6 text-green-400 font-medium hidden"></div>
    </div>

    <div class="glass rounded-3xl p-8">
      <h3 class="text-2xl font-bold mb-6 flex items-center gap-3">
        <i data-lucide="sparkles" class="w-8 h-8"></i>
        AI Product Scan <span class="bg-yellow-400 text-black px-3 py-1 rounded-full text-xs font-bold">PRO</span>
      </h3>
      <input type="file" id="scanImage" accept="image/*" capture="environment" class="block w-full text-sm file:mr-4 file:py-3 file:px-6 file:rounded-full file:bg-gradient-to-r file:from-blue-600 file:to-purple-600 file:text-white"/>
      <button id="scanBtn" class="mt-4 w-full bg-gradient-to-r from-blue-600 to-purple-600 hover:from-blue-700 hover:to-purple-700 text-white font-bold py-6 rounded-3xl shadow-xl">
        Scan with AI
      </button>
      <div id="scanLoading" class="hidden text-center mt-6"><div class="spinner inline-block"></div><p class="mt-3">Analyzing...</p></div>
      <div id="scanResult" class="mt-6 p-6 bg-white/20 rounded-2xl hidden"><pre id="scanText" class="text-xs overflow-x-auto"></pre></div>
    </div>

    <div class="glass rounded-3xl overflow-hidden">
      <div class="flex bg-white/10">
        <button class="tab-btn flex-1 py-5 font-bold text-lg tab-active" data-tab="inventory">Inventory</button>
        <button class="tab-btn flex-1 py-5 font-bold text-lg" data-tab="shopping">Shopping</button>
      </div>

      <section id="inventory" class="p-10">
        <h3 class="text-2xl font-bold mb-8 text-center">Add to Pantry</h3>
        <input type="text" id="invBarcode" placeholder="Barcode" class="w-full p-5 rounded-2xl glass text-lg mb-6"/>
        <div class="grid grid-cols-2 gap-6 mb-8">
          <input type="number" id="invQty" value="1" class="p-5 rounded-2xl glass text-lg"/>
          <input type="date" id="invExp" class="p-5 rounded-2xl glass text-lg"/>
        </div>
        <button id="addToInventory" class="w-full bg-green-600 hover:bg-green-700 text-white font-bold py-6 rounded-2xl text-xl shadow-xl">
          Add to Inventory
        </button>
        <div id="inventoryList" class="mt-8 space-y-4"></div>
      </section>

      <section id="shopping" class="p-10 hidden">
        <h3 class="text-2xl font-bold mb-8 text-center">Shopping List</h3>
        <input type="text" id="shopName" placeholder="Item Name" class="w-full p-5 rounded-2xl glass text-lg mb-6"/>
        <input type="number" id="shopNeeded" value="1" class="w-full p-5 rounded-2xl glass text-lg mb-6"/>
        <button id="addToShopping" class="w-full bg-green-600 hover:bg-green-700 text-white font-bold py-6 rounded-2xl text-xl shadow-xl">
          Add to List
        </button>
        <div id="shoppingList" class="mt-8 space-y-4"></div>
      </section>
    </div>
  </main>

  <div id="scannerModal" class="fixed inset-0 bg-black bg-opacity-80 flex items-center justify-center z-50 hidden">
    <div class="bg-white dark:bg-gray-800 p-6 rounded-3xl w-full max-w-lg">
      <div class="flex justify-between items-center mb-4">
        <h3 class="text-xl font-bold">Scan Barcode</h3>
        <button id="closeScanner"><i data-lucide="x" class="w-8 h-8"></i></button>
      </div>
      <div class="relative">
        <div id="scanner-overlay"></div>
        <video id="scanner-video" class="w-full rounded-2xl" autoplay playsinline></video>
      </div>
      <p class="text-center mt-4" id="scannerStatus">Point at barcode...</p>
    </div>
  </div>

  <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/ui/6.0.2/firebase-ui-auth.js"></script>
  <link type="text/css" rel="stylesheet" href="https://www.gstatic.com/firebasejs/ui/6.0.2/firebase-ui-auth.css" />

  <script>
    lucide.createIcons();
    const firebaseConfig = { apiKey: "AIzaSyDBoPIbHabZnjdScsTyFi3osVyPp88KuSM", authDomain: "pantrypal-6e410.firebaseapp.com", projectId: "pantrypal-6e410", storageBucket: "pantrypal-6e410.firebasestorage.app", messagingSenderId: "592127259891", appId: "1:592127259891:web:fcc158b7b1c35ce0b3b386" };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();
    const ui = new firebaseui.auth.AuthUI(firebase.auth());
    ui.start('#firebaseui-auth-container', { signInFlow: 'popup', signInOptions: ['google.com','emailLink','password','phone'], callbacks: { signInSuccessWithAuthResult: () => false } });

    let idToken = null, isPro = false;
    const $ = s => document.querySelector(s);
    const API_BASE = window.location.origin;

    async function api(path, opts = {}) {
      if (!idToken) return null;
      const res = await fetch(API_BASE + path, { ...opts, headers: { 'Authorization': `Bearer ${idToken}`, 'Content-Type': 'application/json', ...opts.headers } });
      return res.ok ? await res.json() : null;
    }

    firebase.auth().onAuthStateChanged(async user => {
      if (user) {
        idToken = await user.getIdToken();
        $('#userEmail').textContent = user.email || user.phoneNumber;
        $('#auth-section').classList.add('hidden');
        $('#app').classList.remove('hidden');
        const u = await api('/user-info');
        isPro = u?.isPro ?? false;
        $('#proStatus').textContent = isPro ? 'PRO' : 'FREE';
        await Promise.all([loadInventory(), loadShopping(), loadScanCount()]);
      } else {
        $('#auth-section').classList.remove('hidden');
        $('#app').classList.add('hidden');
      }
    });

    $('#darkModeBtn').onclick = () => {
      document.documentElement.classList.toggle('dark');
      localStorage.setItem('darkMode', document.documentElement.classList.contains('dark'));
    };
    if (localStorage.getItem('darkMode') === 'true') document.documentElement.classList.add('dark');

    document.querySelectorAll('.tab-btn').forEach(btn => {
      btn.onclick = () => {
        document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('tab-active'));
        btn.classList.add('tab-active');
        document.querySelectorAll('section[id]').forEach(s => s.classList.add('hidden'));
        $(`#${btn.dataset.tab}`).classList.remove('hidden');
      };
    });

    // ADD TO INVENTORY — FIXED
    $('#addToInventory').onclick = async () => {
      const barcode = $('#invBarcode').value.trim();
      const qty = parseInt($('#invQty').value) || 1;
      const exp = $('#invExp').value;
      if (!barcode) return alert('Enter barcode');
      const res = await api('/inventory', {
        method: 'POST',
        body: JSON.stringify({ barcode, quantity: qty, expiration: exp })
      });
      if (res?.success) {
        $('#invBarcode').value = '';
        $('#invQty').value = 1;
        $('#invExp').value = '';
        alert('Added to inventory!');
        loadInventory();
      } else {
        alert('Failed — check backend logs');
      }
    };

    // LOAD INVENTORY
    async function loadInventory() {
      const data = await api('/inventory');
      const list = $('#inventoryList');
      list.innerHTML = '';
      (data?.items || []).forEach(item => {
        const div = document.createElement('div');
        div.className = 'glass rounded-2xl p-4 flex justify-between items-center';
        div.innerHTML = `<span class="font-bold">${item.name || item.barcode}</span><span>x${item.quantity} ${item.expiration ? '| Exp: ' + item.expiration : ''}</span>`;
        list.appendChild(div);
      });
    }

    // ADD TO SHOPPING
    $('#addToShopping').onclick = async () => {
      const name = $('#shopName').value.trim();
      const needed = parseInt($('#shopNeeded').value) || 1;
      if (!name) return alert('Enter item name');
      const res = await api('/shopping', {
        method: 'POST',
        body: JSON.stringify({ itemName: name, needed })
      });
      if (res?.success) {
        $('#shopName').value = '';
        $('#shopNeeded').value = 1;
        alert('Added to shopping list!');
        loadShopping();
      }
    };

    async function loadShopping() {
      const data = await api('/shopping');
      const list = $('#shoppingList');
      list.innerHTML = '';
      (data?.list || []).forEach(item => {
        const div = document.createElement('div');
        div.className = 'glass rounded-2xl p-4';
        div.textContent = `${item.itemName} (x${item.needed})`;
        list.appendChild(div);
      });
    }

    async function loadScanCount() {
      const d = await api('/user-info');
      $('#scanCounter').textContent = d?.isPro ? 'Unlimited AI Scans' : `Free scans: ${d?.scans || 0}/10`;
    }

    // Scanner, Voice, AI Scan — all working (your original code)

    loadInventory(); loadShopping(); loadScanCount();
  </script>
</body>
</html>
