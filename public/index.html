<!DOCTYPE html>
<html lang="en" class="h-full">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"/>
  <title>PantryPal Pro</title>
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="default">
  <meta name="theme-color" content="#7c3aed">
  
  <!-- Icons & Fonts -->
  <script src="https://cdn.jsdelivr.net/npm/lucide@latest/dist/umd/lucide.min.js"></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@500;600;700&display=swap" rel="stylesheet"/>
  <script src="https://cdn.tailwindcss.com"></script>
  
  <!-- Firebase -->
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/ui/6.0.1/firebase-ui-auth.js"></script>
  <link rel="stylesheet" href="https://www.gstatic.com/firebasejs/ui/6.0.1/firebase-ui-auth.css"/>
  
  <!-- Scanner & Voice -->
  <script src="https://cdn.jsdelivr.net/npm/@zxing/library@0.19.1/umd/index.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/annyang@2.6.1/annyang.min.js"></script>

  <style>
    :root {
      --primary: #7c3aed;
      --primary-light: #a78bfa;
      --success: #10b981;
      --danger: #ef4444;
      --gray-100: #f3f4f6;
      --gray-800: #1f2937;
    }
    .dark {
      --primary: #a78bfa;
      --primary-light: #c4b5fd;
    }
    body { font-family: 'Inter', sans-serif; }
    .glass { background: rgba(255,255,255,0.9); backdrop-filter: blur(16px); border: 1px solid rgba(255,255,255,0.3); }
    .dark .glass { background: rgba(31,41,55,0.9); border-color: rgba(255,255,255,0.1); }
    .btn { @apply w-full py-4 rounded-2xl font-bold text-lg transition-all active:scale-95; }
    .input { @apply w-full px-5 py-4 rounded-2xl glass text-lg; }
    .tab-active { @apply text-white bg-gradient-to-r from-purple-600 to-pink-600; }
    .delete-btn { @apply text-red-500 font-bold text-sm px-3 py-1 rounded-full bg-red-100 dark:bg-red-900; }
    .scan-glow { box-shadow: 0 0 20px rgba(124,58,237,0.5); }
  </style>
</head>
<body class="min-h-screen bg-gradient-to-br from-purple-600 via-pink-500 to-orange-400 text-gray-900 dark:text-white">

  <!-- AUTH -->
  <div id="auth-section" class="flex items-center justify-center min-h-screen p-6">
    <div class="glass p-8 rounded-3xl shadow-2xl w-full max-w-sm">
      <div class="text-center mb-8">
        <div class="w-20 h-20 bg-gradient-to-r from-purple-500 to-pink-500 rounded-full mx-auto mb-4 flex items-center justify-center">
          <i data-lucide="package" class="w-10 h-10 text-white"></i>
        </div>
        <h1 class="text-3xl font-bold">PantryPal Pro</h1>
        <p class="text-sm opacity-70 mt-2">Smart pantry, zero waste</p>
      </div>
      <div id="firebaseui-auth-container"></div>
    </div>
  </div>

  <!-- MAIN APP -->
  <div id="app" class="hidden pb-24">
    <!-- Header -->
    <header class="glass sticky top-0 z-50 shadow-lg backdrop-blur-xl">
      <div class="px-6 py-4 flex justify-between items-center">
        <div class="flex items-center space-x-3">
          <div class="w-10 h-10 bg-gradient-to-r from-purple-500 to-pink-500 rounded-full flex items-center justify-center">
            <i data-lucide="package" class="w-6 h-6 text-white"></i>
          </div>
          <div>
            <h1 class="text-xl font-bold">PantryPal</h1>
            <p id="userEmail" class="text-xs opacity-70"></p>
          </div>
        </div>
        <button id="signOutBtn" class="p-2 rounded-full bg-red-500 text-white">
          <i data-lucide="log-out" class="w-5 h-5"></i>
        </button>
      </div>
    </header>

    <!-- Content -->
    <main class="px-6 py-6 space-y-6">

      <!-- Quick Stats -->
      <div class="glass p-5 rounded-3xl flex justify-between items-center">
        <div>
          <p class="text-sm opacity-70">AI Scans</p>
          <p id="scanCounter" class="text-2xl font-bold">Loading...</p>
        </div>
        <div class="w-16 h-16 bg-gradient-to-r from-yellow-400 to-orange-500 rounded-full flex items-center justify-center">
          <i data-lucide="zap" class="w-8 h-8 text-white"></i>
        </div>
      </div>

      <!-- INVENTORY -->
      <section id="inventory">
        <div class="glass p-6 rounded-3xl space-y-5">
          <h2 class="text-xl font-bold flex items-center">
            <i data-lucide="archive" class="w-6 h-6 mr-2"></i> Add to Pantry
          </h2>
          
          <input id="invBarcode" type="text" placeholder="Scan or type barcode" class="input" autofocus/>
          
          <div class="grid grid-cols-2 gap-3">
            <input id="invQty" type="number" value="1" min="1" class="input text-center"/>
            <input id="invExp" type="date" class="input"/>
          </div>

          <button id="addToInventory" class="btn bg-gradient-to-r from-green-500 to-emerald-600 text-white">
            <i data-lucide="plus" class="w-5 h-5 mr-2"></i> Add Item
          </button>

          <div id="inventoryList" class="space-y-3 max-h-96 overflow-y-auto"></div>
        </div>
      </section>

      <!-- SHOPPING LIST -->
      <section id="shopping" class="hidden">
        <div class="glass p-6 rounded-3xl space-y-5">
          <h2 class="text-xl font-bold flex items-center">
            <i data-lucide="shopping-cart" class="w-6 h-6 mr-2"></i> Shopping List
          </h2>

          <input id="shopName" type="text" placeholder="What do you need?" class="input"/>
          
          <div class="flex gap-3">
            <input id="shopNeeded" type="number" value="1" min="1" class="input flex-1 text-center"/>
            <button id="addToShopping" class="btn bg-gradient-to-r from-blue-500 to-cyan-600 text-white flex-1">
              <i data-lucide="plus" class="w-5 h-5"></i>
            </button>
          </div>

          <div id="shoppingList" class="space-y-3 max-h-96 overflow-y-auto"></div>
        </div>
      </section>

      <!-- SCANNER -->
      <section id="scanner" class="hidden">
        <div class="glass p-6 rounded-3xl space-y-5 text-center">
          <h2 class="text-xl font-bold flex items-center justify-center">
            <i data-lucide="camera" class="w-6 h-6 mr-2"></i> Scan Barcode
          </h2>

          <div class="relative">
            <video id="video" class="w-full rounded-2xl scan-glow" playsinline></video>
            <div class="absolute inset-0 border-4 border-purple-500 border-dashed rounded-2xl pointer-events-none"></div>
          </div>

          <button id="startScanner" class="btn bg-gradient-to-r from-purple-600 to-pink-600 text-white">
            <i data-lucide="scan" class="w-5 h-5 mr-2"></i> Start Scanner
          </button>

          <p id="scanResult" class="text-lg font-mono break-all"></p>
        </div>
      </section>

      <!-- VOICE -->
      <section id="voice" class="hidden">
        <div class="glass p-6 rounded-3xl space-y-6 text-center">
          <h2 class="text-xl font-bold flex items-center justify-center">
            <i data-lucide="mic" class="w-6 h-6 mr-2"></i> Voice Add
          </h2>

          <button id="voiceBtn" class="w-32 h-32 mx-auto bg-gradient-to-r from-red-500 to-pink-600 rounded-full flex items-center justify-center text-white text-5xl shadow-2xl active:scale-95 transition-all">
            Microphone
          </button>

          <p class="text-sm opacity-70">Hold & say: <br><strong>"Add milk quantity 2"</strong></p>
          <p id="voiceResult" class="text-lg font-bold text-green-500"></p>
        </div>
      </section>

      <!-- AI SCAN -->
      <section id="ai" class="hidden">
        <div class="glass p-6 rounded-3xl space-y-5 text-center">
          <h2 class="text-xl font-bold flex items-center justify-center">
            <i data-lucide="sparkles" class="w-6 h-6 mr-2"></i> AI Photo Scan (Pro)
          </h2>

          <label class="block">
            <input type="file" id="aiImage" accept="image/*" capture="environment" class="hidden"/>
            <div class="btn bg-gradient-to-r from-indigo-500 to-purple-600 text-white cursor-pointer">
              <i data-lucide="camera" class="w-5 h-5 mr-2"></i> Take Photo
            </div>
          </label>

          <button id="aiScanBtn" class="btn bg-gradient-to-r from-purple-600 to-pink-600 text-white">
            <i data-lucide="wand-2" class="w-5 h-5 mr-2"></i> Scan with AI
          </button>

          <div id="aiResult" class="space-y-2"></div>
        </div>
      </section>
    </main>

    <!-- BOTTOM NAV -->
    <nav class="fixed bottom-0 left-0 right-0 glass border-t border-white/20 backdrop-blur-xl">
      <div class="flex justify-around py-3">
        <button class="tab-btn tab-active p-3 rounded-2xl" data-tab="inventory">
          <i data-lucide="home" class="w-6 h-6"></i>
        </button>
        <button class="tab-btn p-3 rounded-2xl" data-tab="shopping">
          <i data-lucide="shopping-cart" class="w-6 h-6"></i>
        </button>
        <button class="tab-btn p-3 rounded-2xl" data-tab="scanner">
          <i data-lucide="scan" class="w-6 h-6"></i>
        </button>
        <button class="tab-btn p-3 rounded-2xl" data-tab="voice">
          <i data-lucide="mic" class="w-6 h-6"></i>
        </button>
        <button class="tab-btn p-3 rounded-2xl" data-tab="ai">
          <i data-lucide="sparkles" class="w-6 h-6"></i>
        </button>
      </div>
    </nav>
  </div>

  <script>
    lucide.createIcons();
    const API_BASE = window.location.origin;

    const firebaseConfig = {
      apiKey: "AIzaSyDBoPIbHabZnjdScsTyFi3osVyPp88KuSM",
      authDomain: "pantrypal-6e410.firebaseapp.com",
      projectId: "pantrypal-6e410",
      storageBucket: "pantrypal-6e410.firebasestorage.app",
      messagingSenderId: "592127259891",
      appId: "1:592127259891:web:fcc158b7b1c35ce0b3b386"
    };

    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const ui = new firebaseui.auth.AuthUI(auth);
    let idToken = null;
    const $ = s => document.querySelector(s);

    // === AUTH ===
    auth.onAuthStateChanged(async (user) => {
      if (user) {
        idToken = await user.getIdToken();
        $('#userEmail').textContent = user.email.split('@')[0];
        $('#auth-section').classList.add('hidden');
        $('#app').classList.remove('hidden');
        await Promise.all([loadInventory(), loadShopping(), loadScanCount()]);
      } else {
        idToken = null;
        $('#auth-section').classList.remove('hidden');
        $('#app').classList.add('hidden');
        ui.start('#firebaseui-auth-container', {
          signInFlow: 'popup',
          signInOptions: [
            firebase.auth.GoogleAuthProvider.PROVIDER_ID,
            firebase.auth.EmailAuthProvider.PROVIDER_ID
          ],
          callbacks: { signInSuccessWithAuthResult: () => false }
        });
      }
    });

    $('#signOutBtn').onclick = () => auth.signOut();

    // === API ===
    async function api(path, opts = {}) {
      if (!idToken) return null;
      const res = await fetch(API_BASE + path, {
        ...opts,
        headers: {
          'Authorization': `Bearer ${idToken}`,
          'Content-Type': 'application/json',
          ...opts.headers
        }
      });
      return res.ok ? await res.json() : null;
    }

    // === TABS ===
    document.querySelectorAll('.tab-btn').forEach(btn => {
      btn.onclick = () => {
        document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('tab-active'));
        btn.classList.add('tab-active');
        document.querySelectorAll('section[id]').forEach(s => s.classList.add('hidden'));
        $(`#${btn.dataset.tab}`).classList.remove('hidden');
      };
    });

    // === INVENTORY ===
    $('#addToInventory').onclick = async () => {
      const barcode = $('#invBarcode').value.trim();
      const qty = parseInt($('#invQty').value) || 1;
      const exp = $('#invExp').value;
      if (!barcode) return alert('Scan or enter barcode');
      const res = await api('/api/inventory', { method: 'POST', body: JSON.stringify({ barcode, quantity: qty, expiration: exp }) });
      if (res?.success) {
        $('#invBarcode').value = ''; $('#invQty').value = 1; $('#invExp').value = '';
        loadInventory();
      }
    };

    async function loadInventory() {
      const data = await api('/api/inventory');
      const list = $('#inventoryList');
      list.innerHTML = '';
      (data?.items || []).forEach((item, i) => {
        const div = document.createElement('div');
        div.className = 'glass rounded-2xl p-4 flex justify-between items-center';
        div.innerHTML = `
          <div>
            <div class="font-bold text-lg">${item.name || item.barcode}</div>
            <div class="text-sm opacity-70">x${item.quantity} ${item.expiration ? `â€¢ Exp: ${item.expiration}` : ''}</div>
          </div>
          <button class="delete-btn" data-type="inventory" data-index="${i}">Delete</button>
        `;
        list.appendChild(div);
      });
    }

    // === SHOPPING ===
    $('#addToShopping').onclick = async () => {
      const name = $('#shopName').value.trim();
      const needed = parseInt($('#shopNeeded').value) || 1;
      if (!name) return;
      const res = await api('/api/shopping', { method: 'POST', body: JSON.stringify({ itemName: name, needed }) });
      if (res?.success) {
        $('#shopName').value = ''; $('#shopNeeded').value = 1;
        loadShopping();
      }
    };

    async function loadShopping() {
      const data = await api('/api/shopping');
      const list = $('#shoppingList');
      list.innerHTML = '';
      (data?.list || []).forEach((item, i) => {
        const div = document.createElement('div');
        div.className = 'glass rounded-2xl p-4 flex justify-between items-center';
        div.innerHTML = `
          <div class="font-bold text-lg">${item.itemName}</div>
          <div class="text-sm opacity-70">x${item.needed}</div>
          <button class="delete-btn ml-3" data-type="shopping" data-index="${i}">Delete</button>
        `;
        list.appendChild(div);
      });
    }

    // === DELETE ===
    document.addEventListener('click', async (e) => {
      if (!e.target.classList.contains('delete-btn')) return;
      const type = e.target.dataset.type;
      const index = parseInt(e.target.dataset.index);
      if (!confirm('Delete?')) return;

      const data = type === 'inventory' ? (await api('/api/inventory')) : (await api('/api/shopping'));
      const array = type === 'inventory' ? data?.items : data?.list;
      array.splice(index, 1);

      await api(type === 'inventory' ? '/api/inventory' : '/api/shopping', {
        method: 'POST',
        body: JSON.stringify(type === 'inventory' ? { inventory: array } : { shopping: array })
      });

      type === 'inventory' ? loadInventory() : loadShopping();
    });

    async function loadScanCount() {
      const d = await api('/api/user-info');
      $('#scanCounter').textContent = d?.isPro ? 'Unlimited AI' : `${d?.scans || 0}/10 Scans`;
    }

    // === SCANNER ===
    let codeReader;
    $('#startScanner').onclick = () => {
      if (codeReader) {
        codeReader.reset(); codeReader = null;
        $('#startScanner').innerHTML = '<i data-lucide="scan" class="w-5 h-5 mr-2"></i> Start Scanner';
        $('#video').srcObject = null;
        lucide.createIcons();
        return;
      }
      codeReader = new ZXing.BrowserMultiFormatReader();
      codeReader.decodeFromVideoDevice(null, 'video', (result) => {
        if (result) {
          $('#scanResult').textContent = result.getText();
          $('#invBarcode').value = result.getText();
          alert('Scanned: ' + result.getText());
          codeReader.reset(); codeReader = null;
          $('#startScanner').innerHTML = '<i data-lucide="scan" class="w-5 h-5 mr-2"></i> Start Scanner';
          $('#video').srcObject = null;
          lucide.createIcons();
        }
      });
      $('#startScanner').innerHTML = '<i data-lucide="square" class="w-5 h-5 mr-2"></i> Stop';
      lucide.createIcons();
    };

    // === VOICE ===
    if (annyang) {
      annyang.addCommands({
        'add *item quantity *qty': (item, qty) => {
          $('#shopName').value = item;
          $('#shopNeeded').value = qty || 1;
          $('#voiceResult').textContent = `Added: ${item} x${qty || 1}`;
        }
      });
      let holdTimer;
      $('#voiceBtn').ontouchstart = $('#voiceBtn').onmousedown = (e) => {
        e.preventDefault();
        holdTimer = setTimeout(() => annyang.start({ autoRestart: false }), 300);
      };
      $('#voiceBtn').ontouchend = $('#voiceBtn').onmouseup = () => {
        clearTimeout(holdTimer);
        annyang.abort();
      };
    }

    // === AI SCAN ===
    $('#aiImage').onchange = () => {
      if ($('#aiImage').files[0]) $('#aiScanBtn'.click();
    };

    $('#aiScanBtn').onclick = async () => {
      const file = $('#aiImage').files[0];
      if (!file) return;
      const form = new FormData();
      form.append('image', file);
      $('#aiResult').innerHTML = '<p class="text-yellow-400">AI thinking...</p>';
      const res = await fetch(API_BASE + '/api/scan', { method: 'POST', headers: { 'Authorization': `Bearer ${idToken}` }, body: form });
      const data = await res.json();
      $('#aiResult').innerHTML = data.labels?.length
        ? data.labels.map(l => `<div class="inline-block bg-gradient-to-r from-purple-500 to-pink-500 text-white px-4 py-2 rounded-full m-1 font-bold">${l}</div>`).join('')
        : '<p class="text-red-400">Nothing found. Try a clearer photo!</p>';
    };

    // Init
    ui.start('#firebaseui-auth-container', {
      signInFlow: 'popup',
      signInOptions: [firebase.auth.GoogleAuthProvider.PROVIDER_ID, firebase.auth.EmailAuthProvider.PROVIDER_ID],
      callbacks: { signInSuccessWithAuthResult: () => false }
    });
  </script>
</body>
</html>
