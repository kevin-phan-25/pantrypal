<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>PantryPal Pro</title>
  <link rel="manifest" href="/manifest.json">
  <script src="https://www.gstatic.com/firebasejs/10.12.5/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.5/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.5/firebase-messaging-compat.js"></script>
  <script src="https://unpkg.com/@zxing/browser@latest"></script>
  <script src="https://cdn.jsdelivr.net/npm/annyang@2.6.1/annyang.min.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    body { font-family: system-ui, sans-serif; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); min-height: 100vh; margin: 0; }
    .glass { background: rgba(255,255,255,0.1); backdrop-filter: blur(12px); border: 1px solid rgba(255,255,255,0.2); }
    .spinner { border: 4px solid #ffffff40; border-top: 4px solid white; border-radius: 50%; width: 24px; height: 24px; animation: s 1s linear infinite; }
    @keyframes s { to { transform: rotate(360deg); } }
  </style>
</head>
<body class="text-white">

  <!-- LOGIN -->
  <div id="auth" class="flex items-center justify-center min-h-screen p-6">
    <div class="glass p-12 rounded-3xl shadow-2xl max-w-md w-full text-center">
      <h1 class="text-6xl font-black mb-8">PantryPal Pro</h1>
      <button id="googleSignIn" class="w-full py-5 bg-white text-gray-800 rounded-2xl font-bold text-xl flex items-center justify-center gap-4">
        <img src="https://developers.google.com/identity/images/g-logo.png" class="w-10 h-10" alt="G">
        <span id="loginText">Sign in with Google</span>
        <div id="loginSpinner" class="hidden spinner"></div>
      </button>
    </div>
  </div>

  <!-- APP -->
  <div id="app" class="hidden min-h-screen p-6">
    <header class="glass sticky top-0 rounded-2xl shadow-xl p-6 mb-6 flex justify-between items-center">
      <div>
        <h1 class="text-4xl font-black">PantryPal</h1>
        <p id="userEmail" class="opacity-80"></p>
      </div>
      <button id="signOutBtn" class="px-6 py-3 bg-red-600 rounded-xl font-bold">Sign Out</button>
    </header>

    <main>
      <div class="flex gap-4 mb-8 flex-wrap">
        <button class="tab-btn tab-active px-6 py-3 rounded-xl font-bold bg-white/20" data-tab="inventory">Inventory</button>
        <button class="tab-btn px-6 py-3 rounded-xl font-bold" data-tab="scanner">Scanner</button>
      </div>

      <!-- INVENTORY -->
      <section id="inventory">
        <div class="glass p-6 rounded-2xl mb-6">
          <div class="grid grid-cols-3 gap-4">
            <input id="invName" placeholder="Item name or barcode" class="px-4 py-3 rounded-xl text-black">
            <input id="invQty" type="number" value="1" class="px-4 py-3 rounded-xl text-black">
            <button id="addItem" class="bg-emerald-600 rounded-xl font-bold">+ Add</button>
          </div>
        </div>
        <div id="inventoryList" class="space-y-4"></div>
      </section>

      <!-- SCANNER -->
      <section id="scanner" class="hidden text-center">
        <video id="video" width="100%" height="400" class="rounded-2xl mb-6" playsinline></video>
        <button id="startScan" class="px-8 py-4 bg-purple-600 rounded-xl font-bold text-xl">Start Scanner</button>
        <p id="scanResult" class="mt-4 text-2xl"></p>
      </section>
    </main>
  </div>

  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyDBoPIbHabZnjdScsTyFi3osVyPp88KuSM",
      authDomain: "pantrypal-6e410.firebaseapp.com",
      projectId: "pantrypal-6e410",
      storageBucket: "pantrypal-6e410.firebasestorage.app",
      messagingSenderId: "592127259891",
      appId: "1:592127259891:web:fcc158b7b1c35ce0b3b386"
    };
    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const messaging = firebase.messaging();
    const $ = s => document.querySelector(s);

    // === LOGIN ===
    $('#googleSignIn').onclick = () => {
      $('#loginText').classList.add('hidden');
      $('#loginSpinner').classList.remove('hidden');
      auth.signInWithPopup(new firebase.auth.GoogleAuthProvider());
    };

    auth.onAuthStateChanged(user => {
      if (user) {
        $('#userEmail').textContent = user.email;
        $('#auth').classList.add('hidden');
        $('#app').classList.remove('hidden');
        setupPush();
        loadInventory();
      }
    });

    $('#signOutBtn').onclick = () => auth.signOut();

    // === PUSH NOTIFICATIONS (WORKS) ===
    async function setupPush() {
      try {
        await Notification.requestPermission();
        const token = await messaging.getToken({
          vapidKey: "YOUR_VAPID_KEY_HERE"  // ← Step 3 below
        });
        console.log("Push token:", token);
        // Send this token to your backend to save
        await fetch('/api/save-token', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ token, uid: auth.currentUser.uid })
        });
      } catch (e) { console.log("Push denied"); }
    }

    // === INVENTORY (SIMPLE & WORKING) ===
    async function loadInventory() {
      const res = await fetch('/api/inventory');
      const data = await res.json();
      const list = $('#inventoryList');
      list.innerHTML = '';
      (data.items || []).forEach((item, i) => {
        const div = document.createElement('div');
        div.className = 'glass p-6 rounded-2xl flex justify-between items-center';
        div.innerHTML = `<span class="text-xl font-bold">${item.name} ×${item.quantity}</span>
          <button class="text-red-400 font-bold delete-item" data-index="${i}">Delete</button>`;
        list.appendChild(div);
      });
    }

    $('#addItem').onclick = async () => {
      const name = $('#invName').value.trim();
      if (!name) return;
      await fetch('/api/inventory', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ name, quantity: +$('#invQty').value || 1 })
      });
      $('#invName').value = ''; $('#invQty').value = 1;
      loadInventory();
    };

    $('#inventoryList').onclick = async e => {
      if (e.target.classList.contains('delete-item')) {
        const i = e.target.dataset.index;
        await fetch('/api/inventory', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ deleteIndex: +i })
        });
        loadInventory();
      }
    };

    // === SCANNER (ZXing) ===
    let reader = null;
    $('#startScan').onclick = () => {
      if (reader) { reader.reset(); reader = null; $('#startScan').textContent = 'Start Scanner'; return; }
      reader = new ZXing.BrowserMultiFormatReader();
      reader.decodeFromVideoDevice(null, 'video', result => {
        if (result) {
          $('#invName').value = result.text;
          $('#scanResult').textContent = 'Scanned: ' + result.text;
          document.querySelector('[data-tab="inventory"]').click();
          reader.reset(); reader = null;
          $('#startScan').textContent = 'Start Scanner';
        }
      });
      $('#startScan').textContent = 'Stop Scanner';
    };

    // === TABS ===
    document.querySelectorAll('.tab-btn').forEach(b => b.onclick = () => {
      document.querySelectorAll('.tab-btn').forEach(x => x.classList.remove('tab-active', 'bg-white/20'));
      b.classList.add('tab-active', 'bg-white/20');
      document.querySelectorAll('section[id]').forEach(s => s.classList.add('hidden'));
      $(`#${b.dataset.tab}`).classList.remove('hidden');
    });
  </script>
</body>
</html>
