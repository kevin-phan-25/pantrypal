<!-- (Keep everything above the <script> the same) -->

  <!-- Full App Logic -->
  <script>
    // ==== Firebase Config + UI (unchanged) ====
    const firebaseConfig = {
      apiKey: "AIzaSyDBoPIbHabZnjdScsTyFi3osVyPp88KuSM",
      authDomain: "pantrypal-6e410.firebaseapp.com",
      projectId: "pantrypal-6e410",
      storageBucket: "pantrypal-6e410.firebasestorage.app",
      messagingSenderId: "592127259891",
      appId: "1:592127259891:web:fcc158b7b1c35ce0b3b386",
      measurementId: "G-P641JW4KS4"
    };
    firebase.initializeApp(firebaseConfig);

    const ui = new firebaseui.auth.AuthUI(firebase.auth());
    ui.start('#firebaseui-auth-container', {
      signInOptions: [firebase.auth.GoogleAuthProvider.PROVIDER_ID],
      signInSuccessUrl: '/',
      tosUrl: '/tos',
      privacyPolicyUrl: '/privacy'
    });

    let currentUser = null;
    let idToken = null;
    let recognition = null;

    // ==== Auth State (unchanged) ===
    firebase.auth().onAuthStateChanged(async user => {
      if (user) {
        currentUser = user;
        idToken = await user.getIdToken();
        document.getElementById('userEmail').textContent = user.email;
        document.getElementById('auth-section').classList.add('hidden');
        document.getElementById('app').classList.remove('hidden');
        loadInventory();
        loadShopping();
        loadScanCount();
      } else {
        document.getElementById('auth-section').classList.remove('hidden');
        document.getElementById('app').classList.add('hidden');
      }
    });

    document.getElementById('signOutBtn').onclick = () => firebase.auth().signOut();

    // ==== API Helper (unchanged) ===
    async function api(path, opts = {}) {
      if (!idToken) return alert('Not signed in');
      const res = await fetch(path, {
        ...opts,
        headers: {
          'Authorization': `Bearer ${idToken}`,
          'Content-Type': 'application/json',
          ...opts.headers
        }
      });
      if (!res.ok) { const err = await res.text(); alert('API Error: ' + err); return null; }
      return res.json();
    }

    // ==== AI Scan (Improved Debugging) ===
    document.getElementById('scanBtn').onclick = async () => {
      const file = document.getElementById('scanImage').files[0];
      if (!file) return alert('Choose an image');

      const form = new FormData();
      form.append('image', file);

      try {
        const res = await fetch('/scan', {
          method: 'POST',
          headers: { 'Authorization': `Bearer ${idToken}` },
          body: form
        }).then(r => r.json());

        console.log('AI Scan Response:', res);

        const resultDiv = document.getElementById('scanResult');
        const textDiv = document.getElementById('scanText');
        if (res.success) {
          textDiv.textContent = JSON.stringify(res.record, null, 2);
          resultDiv.classList.remove('hidden');

          // Auto-fill inventory if barcode detected
          if (res.record.barcode) {
            document.getElementById('invBarcode').value = res.record.barcode;
            document.querySelector('[data-tab="inventory"]').click();
          }
        } else {
          alert('Scan failed: ' + (res.error || 'Unknown error'));
        }
      } catch (err) {
        console.error('Fetch Error:', err);
        alert('Network error: ' + err.message);
      }
    };

    // ==== (Rest of the script remains unchanged â€“ copy your existing logic) ====
    // Dark Mode, Scan Counter, Tabs, Inventory, Shopping, CSV, Voice, Scanner, PWA Install
    // ... [Paste your existing code here, excluding any push-related parts]
  </script>
</body>
</html>
