<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>PantryPal Pro</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet"/>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet"/>
  <style>
    body { background: #f8f9fa; font-family: 'Segoe UI', sans-serif; }
    .card { border-radius: 16px; box-shadow: 0 4px 12px rgba(0,0,0,0.1); }
    .btn-primary { background: #0d6efd; border: none; }
    .btn-primary:hover { background: #0b5ed7; }
    .preview-img { max-height: 200px; object-fit: contain; border-radius: 8px; }
    .url-input { border-radius: 8px; }
    .scan-section { margin-bottom: 2rem; }
    .result-badge { font-size: 0.9rem; }
    .loading { opacity: 0.7; }
    .btn-sm { font-size: 0.85rem; }
  </style>
</head>
<body>
  <div class="container py-5">
    <div class="text-center mb-5">
      <h1 class="display-5 fw-bold text-primary">PantryPal Pro</h1>
      <p class="text-muted">Scan items, manage inventory, and build your shopping list.</p>
    </div>

    <!-- ========== AUTH STATUS ========== -->
    <div id="authSection" class="text-center mb-4">
      <button id="loginBtn" class="btn btn-outline-primary">Sign in with Google</button>
      <div id="userInfo" class="d-none mt-3">
        <p><strong id="userEmail"></strong> <span id="proBadge" class="badge bg-success d-none">PRO</span></p>
        <button id="logoutBtn" class="btn btn-sm btn-outline-danger">Logout</button>
      </div>
    </div>

    <!-- ========== SCAN SECTION ========== -->
    <div id="scanSection" class="d-none card p-4 scan-section">
      <h4 class="mb-3">Scan Item</h4>

      <!-- File Upload -->
      <div class="mb-3">
        <input type="file" id="fileInput" accept="image/*" class="form-control form-control-sm" />
        <button id="scanFileBtn" class="btn btn-primary w-100 mt-2">
          <i class="bi bi-camera"></i> Scan from Photo
        </button>
      </div>

      <!-- OR Separator -->
      <div class="text-center my-3 text-muted fw-bold">— OR —</div>

      <!-- URL Input -->
      <div class="mb-3">
        <div class="input-group">
          <input type="url" id="urlInput" class="form-control" placeholder="https://example.com/item.jpg" />
          <button id="scanUrlBtn" class="btn btn-outline-primary">
            <i class="bi bi-link-45deg"></i>
          </button>
        </div>
        <div class="form-text">Paste a direct image link</div>
      </div>

      <!-- Preview -->
      <div id="preview" class="text-center mb-3 d-none">
        <img id="previewImg" class="preview-img img-fluid" alt="Preview" />
        <p class="text-muted mt-2">Ready to scan</p>
      </div>

      <!-- Result -->
      <div id="scanResult" class="d-none mt-4"></div>
    </div>

    <!-- ========== INVENTORY & SHOPPING ========== -->
    <div id="mainApp" class="d-none row g-4 mt-3">
      <!-- Inventory -->
      <div class="col-lg-6">
        <div class="card h-100 p-4">
          <h5>Inventory</h5>
          <div id="inventoryList" class="mb-3"></div>
          <button id="addManualBtn" class="btn btn-sm btn-outline-secondary w-100">+ Add Item Manually</button>
        </div>
      </div>

      <!-- Shopping List -->
      <div class="col-lg-6">
        <div class="card h-100 p-4">
          <h5>Shopping List</h5>
          <div id="shoppingList" class="mb-3"></div>
          <div class="input-group">
            <input id="newItemInput" class="form-control form-control-sm" placeholder="Add new item..." />
            <button id="addShoppingBtn" class="btn btn-sm btn-success">Add</button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Firebase SDK -->
  <script src="https://www.gstatic.com/firebasejs/10.14.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.14.1/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.14.1/firebase-firestore-compat.js"></script>

  <script>
    // ========== REPLACE WITH YOUR FIREBASE CONFIG ==========
    const firebaseConfig = {
      apiKey: "YOUR_API_KEY",
      authDomain: "YOUR_PROJECT.firebaseapp.com",
      projectId: "YOUR_PROJECT",
      storageBucket: "YOUR_PROJECT.appspot.com",
      messagingSenderId: "1234567890",
      appId: "1:1234567890:web:abcdef123456"
    };
    // =======================================================

    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.firestore();

    // ========== DOM ELEMENTS ==========
    const loginBtn = document.getElementById('loginBtn');
    const logoutBtn = document.getElementById('logoutBtn');
    const userEmail = document.getElementById('userEmail');
    const proBadge = document.getElementById('proBadge');
    const authSection = document.getElementById('authSection');
    const userInfo = document.getElementById('userInfo');
    const scanSection = document.getElementById('scanSection');
    const mainApp = document.getElementById('mainApp');

    const fileInput = document.getElementById('fileInput');
    const scanFileBtn = document.getElementById('scanFileBtn');
    const urlInput = document.getElementById('urlInput');
    const scanUrlBtn = document.getElementById('scanUrlBtn');
    const preview = document.getElementById('preview');
    const previewImg = document.getElementById('previewImg');
    const scanResult = document.getElementById('scanResult');

    const inventoryList = document.getElementById('inventoryList');
    const shoppingList = document.getElementById('shoppingList');
    const addManualBtn = document.getElementById('addManualBtn');
    const newItemInput = document.getElementById('newItemInput');
    const addShoppingBtn = document.getElementById('addShoppingBtn');

    let idToken = null;

    // ========== AUTH ==========
    const googleProvider = new firebase.auth.GoogleAuthProvider();

    loginBtn.addEventListener('click', () => auth.signInWithPopup(googleProvider));
    logoutBtn.addEventListener('click', () => auth.signOut());

    auth.onAuthStateChanged(async (user) => {
      if (user) {
        idToken = await user.getIdToken();
        userEmail.textContent = user.email;
        userInfo.classList.remove('d-none');
        loginBtn.classList.add('d-none');
        loadUserData();
        scanSection.classList.remove('d-none');
        mainApp.classList.remove('d-none');
      } else {
        idToken = null;
        userInfo.classList.add('d-none');
        loginBtn.classList.remove('d-none');
        scanSection.classList.add('d-none');
        mainApp.classList.add('d-none');
      }
    });

    // ========== USER DATA ==========
    async function loadUserData() {
      try {
        const res = await fetch('/api/user-info', {
          headers: { Authorization: `Bearer ${idToken}` }
        });
        const data = await res.json();
        proBadge.classList.toggle('d-none', !data.isPro);
        loadInventory();
        loadShopping();
      } catch (err) {
        console.error('Failed to load user info:', err);
      }
    }

    // ========== INVENTORY ==========
    async function loadInventory() {
      try {
        const res = await fetch('/api/inventory', {
          headers: { Authorization: `Bearer ${idToken}` }
        });
        const { items } = await res.json();
        inventoryList.innerHTML = items.length ? '' : '<p class="text-muted">No items yet</p>';
        items.forEach(item => {
          const div = document.createElement('div');
          div.className = 'd-flex justify-content-between align-items-center border-bottom py-2';
          div.innerHTML = `
            <div>
              <strong>${escapeHtml(item.name || item.barcode)}</strong><br>
              <small>Qty: ${item.quantity} ${item.expiration ? `| Exp: ${escapeHtml(item.expiration)}` : ''}</small>
            </div>
            <button class="btn btn-sm btn-outline-danger" data-barcode="${item.barcode}">Remove</button>
          `;
          inventoryList.appendChild(div);
        });

        // Attach remove listeners
        document.querySelectorAll('#inventoryList button').forEach(btn => {
          btn.addEventListener('click', async () => {
            const barcode = btn.dataset.barcode;
            await removeFromInventory(barcode);
          });
        });
      } catch (err) {
        inventoryList.innerHTML = '<p class="text-danger">Failed to load inventory</p>';
      }
    }

    async function removeFromInventory(barcode) {
      try {
        const res = await fetch('/api/inventory', { headers: { Authorization: `Bearer ${idToken}` } });
        const { items } = await res.json();
        const updated = items.filter(i => i.barcode !== barcode);
        await fetch('/api/inventory', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json', Authorization: `Bearer ${idToken}` },
          body: JSON.stringify({ items: updated })
        });
        loadInventory();
      } catch (err) {
        alert('Failed to remove item');
      }
    }

    addManualBtn.addEventListener('click', () => {
      const barcode = prompt('Enter barcode or name:');
      if (barcode) addToInventory(barcode.trim());
    });

    async function addToInventory(barcode, quantity = 1, expiration = null) {
      try {
        await fetch('/api/inventory', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json', Authorization: `Bearer ${idToken}` },
          body: JSON.stringify({ barcode, quantity, expiration })
        });
        loadInventory();
      } catch (err) {
        alert('Failed to add item');
      }
    }

    // ========== SHOPPING LIST ==========
    async function loadShopping() {
      try {
        const res = await fetch('/api/shopping', {
          headers: { Authorization: `Bearer ${idToken}` }
        });
        const { list } = await res.json();
        shoppingList.innerHTML = list.length ? '' : '<p class="text-muted">List is empty</p>';
        list.forEach(item => {
          const div = document.createElement('div');
          div.className = 'form-check';
          div.innerHTML = `
            <input class="form-check-input" type="checkbox" id="shop${item.addedAt}">
            <label class="form-check-label" for="shop${item.addedAt}">
              ${escapeHtml(item.itemName)} ${item.needed > 1 ? `(x${item.needed})` : ''}
            </label>
          `;
          shoppingList.appendChild(div);
        });
      } catch (err) {
        shoppingList.innerHTML = '<p class="text-danger">Failed to load list</p>';
      }
    }

    addShoppingBtn.addEventListener('click', () => {
      const name = newItemInput.value.trim();
      if (!name) return;
      fetch('/api/shopping', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json', Authorization: `Bearer ${idToken}` },
        body: JSON.stringify({ itemName: name })
      }).then(() => {
        newItemInput.value = '';
        loadShopping();
      }).catch(() => alert('Failed to add item'));
    });

    // Enter key in shopping input
    newItemInput.addEventListener('keypress', e => {
      if (e.key === 'Enter') addShoppingBtn.click();
    });

    // ========== SCAN LOGIC ==========
    function showPreview(src) {
      previewImg.src = src;
      preview.classList.remove('d-none');
    }

    function hidePreview() {
      preview.classList.add('d-none');
      previewImg.src = '';
    }

    function showResult(labels) {
      scanResult.classList.remove('d-none', 'loading');
      scanResult.innerHTML = `
        <h6>Detected:</h6>
        <div class="d-flex flex-wrap gap-2 mb-3">
          ${labels.slice(0, 8).map(l => `<span class="badge bg-primary result-badge">${escapeHtml(l)}</span>`).join('')}
        </div>
        <button class="btn btn-sm btn-success" id="addFromScanBtn">
          Add "${escapeHtml(labels[0] || 'Item')}" to Inventory
        </button>
      `;

      document.getElementById('addFromScanBtn')?.addEventListener('click', () => {
        addToInventory(labels[0] || 'Unknown Item');
        scanResult.classList.add('d-none');
        hidePreview();
      });
    }

    async function performScan(body) {
      scanResult.className = 'd-none';
      scanResult.innerHTML = `<p class="text-muted loading"><i class="bi bi-hourglass-split"></i> Scanning...</p>`;
      scanResult.classList.remove('d-none');

      try {
        const res = await fetch('/api/scan', {
          method: 'POST',
          headers: { Authorization: `Bearer ${idToken}` },
          body
        });
        const data = await res.json();
        if (data.error) throw new Error(data.error + (data.details ? `: ${data.details}` : ''));
        showResult(data.labels);
      } catch (err) {
        scanResult.innerHTML = `<p class="text-danger">Scan failed: ${escapeHtml(err.message)}</p>`;
      }
    }

    // File Scan
    scanFileBtn.addEventListener('click', () => {
      const file = fileInput.files[0];
      if (!file) return alert('Please select an image');
      const reader = new FileReader();
      reader.onload = e => {
        showPreview(e.target.result);
        const form = new FormData();
        form.append('image', file);
        performScan(form);
      };
      reader.readAsDataURL(file);
    });

    // URL Scan
    scanUrlBtn.addEventListener('click', () => {
      const url = urlInput.value.trim();
      if (!url) return alert('Enter a valid image URL');
      if (!/^https?:\/\//i.test(url)) return alert('URL must start with http:// or https://');

      showPreview(url);
      performScan(JSON.stringify({ imageUrl: url }));
      urlInput.value = '';
    });

    // Enter key in URL
    urlInput.addEventListener('keypress', e => {
      if (e.key === 'Enter') scanUrlBtn.click();
    });

    // Safe HTML
    function escapeHtml(text) {
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }
  </script>
</body>
</html>
