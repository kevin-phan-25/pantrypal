<!DOCTYPE html>
<html lang="en" class="h-full">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>PantryPal Pro</title>
  <script src="https://cdn.jsdelivr.net/npm/lucide@latest/dist/umd/lucide.min.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/ui/6.0.1/firebase-ui-auth.js"></script>
  <link rel="stylesheet" href="https://www.gstatic.com/firebasejs/ui/6.0.1/firebase-ui-auth.css"/>
  <script src="https://cdn.jsdelivr.net/npm/@zxing/library@0.19.1/umd/index.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/annyang@2.6.1/annyang.min.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet"/>
  <style>
    body { font-family: 'Inter', sans-serif; }
    .glass { background: rgba(255,255,255,0.15); backdrop-filter: blur(12px); border: 1px solid rgba(255,255,255,0.2); }
    .dark .glass { background: rgba(0,0,0,0.3); border: 1px solid rgba(255,255,255,0.1); }
    .tab-active { @apply bg-white text-purple-600 dark:bg-gray-800 dark:text-purple-400; }
    .delete-btn { @apply text-red-500 hover:text-red-700 font-bold text-sm; }
  </style>
</head>
<body class="min-h-screen bg-gradient-to-br from-purple-600 to-blue-600 text-gray-900 dark:text-white transition-colors">
  <!-- AUTH -->
  <div id="auth-section" class="flex items-center justify-center min-h-screen">
    <div class="glass p-10 rounded-3xl shadow-2xl max-w-md w-full">
      <h1 class="text-4xl font-bold text-center mb-8">PantryPal Pro</h1>
      <div id="firebaseui-auth-container"></div>
      <p class="text-center mt-4 text-sm opacity-70">Sign in to unlock Pro features</p>
    </div>
  </div>

  <!-- MAIN APP -->
  <div id="app" class="hidden min-h-screen">
    <header class="glass sticky top-0 z-50 shadow-lg">
      <div class="max-w-6xl mx-auto px-6 py-4 flex justify-between items-center">
        <div class="flex items-center space-x-4">
          <h1 class="text-3xl font-bold">PantryPal Pro</h1>
          <span id="userEmail" class="text-sm opacity-80"></span>
        </div>
        <div class="flex items-center space-x-4">
          <span id="scanCounter" class="text-sm font-medium bg-yellow-400 text-black px-3 py-1 rounded-full"></span>
          <button id="darkModeBtn" class="p-2 rounded-lg glass">Dark Mode</button>
          <button id="signOutBtn" class="px-6 py-2 bg-red-500 text-white rounded-xl font-semibold hover:bg-red-600">Sign Out</button>
        </div>
      </div>
    </header>

    <main class="max-w-6xl mx-auto px-6 py-10">
      <!-- TABS -->
      <div class="flex space-x-4 mb-8 overflow-x-auto">
        <button class="tab-btn tab-active px-6 py-3 rounded-xl font-bold whitespace-nowrap" data-tab="inventory">Inventory</button>
        <button class="tab-btn px-6 py-3 rounded-xl font-bold whitespace-nowrap" data-tab="shopping">Shopping List</button>
        <button class="tab-btn px-6 py-3 rounded-xl font-bold whitespace-nowrap" data-tab="scanner">Scanner</button>
        <button class="tab-btn px-6 py-3 rounded-xl font-bold whitespace-nowrap" data-tab="voice">Voice</button>
        <button class="tab-btn px-6 py-3 rounded-xl font-bold whitespace-nowrap" data-tab="ai">AI Scan (Pro)</button>
      </div>

      <!-- INVENTORY -->
      <section id="inventory">
        <div class="glass p-8 rounded-3xl">
          <h2 class="text-2xl font-bold mb-6">Add to Inventory</h2>
          <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
            <input id="invBarcode" type="text" placeholder="Barcode" class="px-4 py-3 rounded-xl glass"/>
            <input id="invQty" type="number" value="1" min="1" class="px-4 py-3 rounded-xl glass"/>
            <input id="invExp" type="date" class="px-4 py-3 rounded-xl glass"/>
          </div>
          <button id="addToInventory" class="px-8 py-4 bg-green-500 text-white rounded-xl font-bold hover:bg-green-600">Add Item</button>
          <div id="inventoryList" class="mt-8 space-y-4"></div>
        </div>
      </section>

      <!-- SHOPPING -->
      <section id="shopping" class="hidden">
        <div class="glass p-8 rounded-3xl">
          <h2 class="text-2xl font-bold mb-6">Shopping List</h2>
          <div class="flex space-x-4 mb-6">
            <input id="shopName" type="text" placeholder="Item name" class="flex-1 px-4 py-3 rounded-xl glass"/>
            <input id="shopNeeded" type="number" value="1" min="1" class="w-24 px-4 py-3 rounded-xl glass"/>
          </div>
          <button id="addToShopping" class="px-8 py-4 bg-blue-500 text-white rounded-xl font-bold hover:bg-blue-600">Add to List</button>
          <div id="shoppingList" class="mt-8 space-y-4"></div>
        </div>
      </section>

      <!-- SCANNER, VOICE, AI SCAN -->
      <section id="scanner" class="hidden">
        <div class="glass p-8 rounded-3xl text-center">
          <h2 class="text-2xl font-bold mb-6">Scan Barcode / QR</h2>
          <video id="video" width="100%" class="rounded-xl mb-6" autoplay playsinline></video>
          <button id="startScanner" class="px-8 py-4 bg-purple-500 text-white rounded-xl font-bold hover:bg-purple-600">Start Scanner</button>
          <p id="scanResult" class="mt-6 text-xl"></p>
        </div>
      </section>

      <section id="voice" class="hidden">
        <div class="glass p-8 rounded-3xl text-center">
          <h2 class="text-2xl font-bold mb-6">Voice Add</h2>
          <button id="voiceBtn" class="w-24 h-24 bg-red-500 rounded-full text-white text-4xl hover:bg-red-600">Microphone</button>
          <p class="mt-6">Hold to speak: "Add milk quantity 2"</p>
          <p id="voiceResult" class="mt-6 text-xl"></p>
        </div>
      </section>

      <section id="ai" class="hidden">
        <div class="glass p-8 rounded-3xl text-center">
          <h2 class="text-2xl font-bold mb-6">AI Photo Scan (Pro)</h2>
          <input type="file" id="aiImage" accept="image/*" capture="camera" class="mb-6"/>
          <button id="aiScanBtn" class="px-8 py-4 bg-gradient-to-r from-purple-500 to-pink-500 text-white rounded-xl font-bold">Scan Photo</button>
          <div id="aiResult" class="mt-8 text-left"></div>
        </div>
      </section>
    </main>
  </div>

  <script>
    lucide.createIcons();
    const API_BASE = window.location.origin;

    const firebaseConfig = {
      apiKey: "AIzaSyDBoPIbHabZnjdScsTyFi3osVyPp88KuSM",
      authDomain: "pantrypal-6e410.firebaseapp.com",
      projectId: "pantrypal-6e410",
      storageBucket: "pantrypal-6e410.firebasestorage.app",
      messagingSenderId: "592127259891",
      appId: "1:592127259891:web:fcc158b7b1c35ce0b3b386"
    };

    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const ui = new firebaseui.auth.AuthUI(auth);

    let idToken = null;
    const $ = s => document.querySelector(s);

    const uiConfig = {
      signInFlow: 'popup',
      signInOptions: [
        firebase.auth.GoogleAuthProvider.PROVIDER_ID,
        firebase.auth.EmailAuthProvider.PROVIDER_ID
      ],
      callbacks: { signInSuccessWithAuthResult: () => false }
    };

    function showLogin() {
      $('#auth-section').classList.remove('hidden');
      $('#app').classList.add('hidden');
      $('#firebaseui-auth-container').innerHTML = '';
      ui.start('#firebaseui-auth-container', uiConfig);
    }

    auth.onAuthStateChanged(async (user) => {
      if (user) {
        idToken = await user.getIdToken();
        $('#userEmail').textContent = user.email || user.displayName || 'User';
        $('#auth-section').classList.add('hidden');
        $('#app').classList.remove('hidden');
        await Promise.all([loadInventory(), loadShopping(), loadScanCount()]);
      } else {
        idToken = null;
        showLogin();
      }
    });

    $('#signOutBtn').onclick = async () => {
      await auth.signOut();
      alert('Signed out!');
    };

    async function api(path, opts = {}) {
      if (!idToken) return null;
      const res = await fetch(API_BASE + path, {
        ...opts,
        headers: {
          'Authorization': `Bearer ${idToken}`,
          'Content-Type': 'application/json',
          ...opts.headers
        }
      });
      return res.ok ? await res.json() : null;
    }

    // === PRODUCT ICONS ===
    const productIcons = {
      'coke': 'https://img.icons8.com/fluency/48/coca-cola.png',
      'cola': 'https://img.icons8.com/fluency/48/coca-cola.png',
      'milk': 'https://img.icons8.com/fluency/48/milk-bottle.png',
      'bread': 'https://img.icons8.com/fluency/48/bread.png',
      'egg': 'https://img.icons8.com/fluency/48/egg.png',
      'water': 'https://img.icons8.com/fluency/48/water.png',
      'juice': 'https://img.icons8.com/fluency/48/orange-juice.png',
      'apple': 'https://img.icons8.com/fluency/48/apple.png',
      'banana': 'https://img.icons8.com/fluency/48/banana.png',
      'chicken': 'https://img.icons8.com/fluency/48/chicken.png',
      'rice': 'https://img.icons8.com/fluency/48/rice-bowl.png'
    };

    function getProductIcon(name) {
      const lower = name.toLowerCase();
      for (const key in productIcons) {
        if (lower.includes(key)) return productIcons[key];
      }
      return 'https://img.icons8.com/fluency/48/grocery-bag.png'; // default
    }

    // === INVENTORY ===
    $('#addToInventory').onclick = async () => {
      const barcode = $('#invBarcode').value.trim();
      const qty = parseInt($('#invQty').value) || 1;
      const exp = $('#invExp').value;
      if (!barcode) return alert('Enter barcode');
      const res = await api('/api/inventory', { method: 'POST', body: JSON.stringify({ barcode, quantity: qty, expiration: exp }) });
      if (res?.success) {
        $('#invBarcode').value = ''; $('#invQty').value = 1; $('#invExp').value = '';
        alert('Added!');
        loadInventory();
      }
    };

    async function loadInventory() {
      const data = await api('/api/inventory');
      const list = $('#inventoryList');
      list.innerHTML = '';
      (data?.items || []).forEach((item, i) => {
        const name = item.name || item.barcode;
        const icon = getProductIcon(name);
        const div = document.createElement('div');
        div.className = 'glass rounded-2xl p-4 flex items-center space-x-4';
        div.innerHTML = `
          <img src="${icon}" alt="${name}" class="w-12 h-12 rounded-lg object-cover">
          <div class="flex-1">
            <span class="font-bold">${name}</span>
            <span class="text-sm opacity-80">x${item.quantity}</span>
            ${item.expiration ? `<span class="text-xs opacity-70">| Exp: ${item.expiration}</span>` : ''}
          </div>
          <button class="delete-btn" data-type="inventory" data-index="${i}">Delete</button>
        `;
        list.appendChild(div);
      });
    }

    // === SHOPPING ===
    $('#addToShopping').onclick = async () => {
      const name = $('#shopName').value.trim();
      const needed = parseInt($('#shopNeeded').value) || 1;
      if (!name) return alert('Enter item name');
      const res = await api('/api/shopping', { method: 'POST', body: JSON.stringify({ itemName: name, needed }) });
      if (res?.success) {
        $('#shopName').value = ''; $('#shopNeeded').value = 1;
        alert('Added!');
        loadShopping();
      }
    };

    async function loadShopping() {
      const data = await api('/api/shopping');
      const list = $('#shoppingList');
      list.innerHTML = '';
      (data?.list || []).forEach((item, i) => {
        const icon = getProductIcon(item.itemName);
        const div = document.createElement('div');
        div.className = 'glass rounded-2xl p-4 flex items-center space-x-4';
        div.innerHTML = `
          <img src="${icon}" alt="${item.itemName}" class="w-12 h-12 rounded-lg object-cover">
          <div class="flex-1">
            <span>${item.itemName}</span>
            <span class="text-sm opacity-80">(x${item.needed})</span>
          </div>
          <button class="delete-btn" data-type="shopping" data-index="${i}">Delete</button>
        `;
        list.appendChild(div);
      });
    }

    // === DELETE FIXED ===
    document.addEventListener('click', async (e) => {
      if (!e.target.classList.contains('delete-btn')) return;
      const type = e.target.dataset.type;
      const index = parseInt(e.target.dataset.index);
      if (!confirm('Delete this item?')) return;

      // Re-fetch fresh data
      const freshData = type === 'inventory' ? await api('/api/inventory') : await api('/api/shopping');
      const array = type === 'inventory' ? freshData?.items : freshData?.list;
      if (!array || index >= array.length) return;

      array.splice(index, 1);

      // Save updated array
      const res = await api(type === 'inventory' ? '/api/inventory' : '/api/shopping', {
        method: 'POST',
        body: JSON.stringify(type === 'inventory' ? { items: array } : { list: array })
      });

      if (res?.success) {
        alert('Deleted!');
        type === 'inventory' ? loadInventory() : loadShopping();
      }
    });

    async function loadScanCount() {
      const d = await api('/api/user-info');
      $('#scanCounter').textContent = d?.isPro ? 'Unlimited AI Scans (Pro)' : `Free scans: ${d?.scans || 0}/10`;
    }

    // === SCANNER, VOICE, AI SCAN ===
    let codeReader;
    $('#startScanner').onclick = () => {
      if (codeReader) { codeReader.reset(); codeReader = null; $('#startScanner').textContent = 'Start Scanner'; $('#video').srcObject = null; return; }
      codeReader = new ZXing.BrowserMultiFormatReader();
      codeReader.decodeFromVideoDevice(null, 'video', (result) => {
        if (result) {
          $('#scanResult').textContent = 'Found: ' + result.getText();
          $('#invBarcode').value = result.getText();
          alert('Scanned: ' + result.getText());
          codeReader.reset(); codeReader = null;
          $('#startScanner').textContent = 'Start Scanner';
          $('#video').srcObject = null;
        }
      });
      $('#startScanner').textContent = 'Stop Scanner';
    };

    if (annyang) {
      annyang.addCommands({
        'add *item quantity *qty': (item, qty) => {
          $('#shopName').value = item;
          $('#shopNeeded').value = qty || 1;
          $('#voiceResult').textContent = `Added: ${item} x${qty || 1}`;
        }
      });
      $('#voiceBtn').onmousedown = $('#voiceBtn').ontouchstart = () => annyang.start({ autoRestart: false });
      $('#voiceBtn').onmouseup = $('#voiceBtn').ontouchend = () => annyang.abort();
    }

    $('#aiScanBtn').onclick = async () => {
      const file = $('#aiImage').files[0];
      if (!file) return alert('Take a photo first');
      const form = new FormData();
      form.append('image', file);
      $('#aiResult').innerHTML = '<p class="text-yellow-300">Scanning...</p>';
      const res = await fetch(API_BASE + '/api/scan', { method: 'POST', headers: { 'Authorization': `Bearer ${idToken}` }, body: form });
      const data = await res.json();
      $('#aiResult').innerHTML = data.labels?.length
        ? `<p class="text-green-400 font-bold mb-4">Found:</p>${data.labels.map(l => `<div class="p-3 glass rounded-lg inline-block mr-2 mb-2">${l}</div>`).join('')}`
        : '<p class="text-red-400">Nothing detected. Try again!</p>';
    };

    showLogin();
  </script>
</body>
</html>
